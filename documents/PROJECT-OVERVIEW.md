# PROJECT-OVERVIEW.md
**Проект:** «Континуум» закрытая платформа обучения (2+ преподавателя + их ученики)  
**Аудитория документа:** нейросетевой агент / команда разработки  

---

## 1) Цель продукта
Сделать **закрытое веб-приложение** для преподавателей и их учеников, где:
- преподаватели создают и публикуют учебный контент (курсы → разделы → юниты → задачи),
- ученик проходит юниты, решает задачи и получает прогресс,
- доступ к юнитам открывается автоматически по правилам графа и прохождению prereq-юнитов,
- отдельный режим ручной проверки для фото-ответов ведущим преподавателем.

---

## 2) Границы и ограничения (обязательные)
### 2.1 Закрытая система
- **Нет публичной регистрации**.
- Доступ ученикам выдаётся **только преподавателем**.

### 2.2 Иерархическая публикация (видимость)
Контент виден ученику **только если**:
- сам объект `published`,
- и **все родители** по цепочке `Course → Section → Unit → Task` — тоже `published`.

Если **родитель draft**, то **всё ниже скрыто**.

### 2.3 Unpublish = “объекта нет”
Если объект снят с публикации, то для ученика:
- объект **пропадает из UI**,
- объект **не учитывается** в статистике/прогрессе,
- выполняется пересчёт.

История попыток и audit log **сохраняются** для админов.

---

## 3) Роли и доступы
### 3.1 Teacher/Admin
- Полный CRUD по контенту: курс/раздел/юнит/задачи/решения/граф/правила допуска.
- Управление пользователями:
  - создание учеников,
  - выдача/сброс пароля,
  - создание учителей (может быть больше 2),
  - смена ведущего учителя ученика (прогресс сохраняется).
- Просмотр прогресса всех учеников.
- Проверка фото-ответов: **только ведущий учитель ученика**.
- Override: ручное открытие юнита ученику **навсегда**.
- Audit log: просмотр событий.

### 3.2 Student
- Вход по логину/паролю (получает от преподавателя).
- Видит только доступный опубликованный контент.
- Проходит юниты, решает задачи, смотрит прогресс и статусы.
- Получает доступ к следующим юнитам по unlock-правилам.

---

## 4) Модель контента
### 4.1 Иерархия
- **Course** → **Section** → **Unit** → **Task**
- У курса/раздела/юнита/задачи: `status = draft | published`

### 4.2 Unit
- Теория: `theory_rich_latex` компилируется на сервере (Tectonic) → PDF в S3 → отображение в UI **без браузерного PDF-viewer**.
- Медиа: видео embed + вложения.
- Задачи: список задач (часть обязательные).
- `min_counted_tasks` — абсолютный порог “юнит пройден” по counted задачам.

### 4.3 Task
- Условие и варианты: LiteTeX (KaTeX на фронте).
- Решение: Rich LaTeX (опционально) компилируется на сервере → PDF.
- Типы ответа: `numeric | single_choice | multi_choice | photo`
- Numeric: всегда через `numeric_parts[]` (даже если одна часть).
- Single/Multi: варианты перемешиваются **на фронтенде** на каждую попытку (backend порядок не хранит).

### 4.4 Ревизии задач
- **Любое изменение** задачи → **новая ревизия** (`task_revision_id`).
- Если задача была **засчитана** ученику — она **остаётся засчитанной** даже после создания новой ревизии.
- Счётчики попыток/ошибок/блокировок ведутся **по активной ревизии**.

---

## 5) Граф юнитов и unlock rules
### 5.1 Граф
- В каждом разделе есть ориентированный граф юнитов.
- Граф **не пересекает разделы**.

### 5.2 Статусы юнита для ученика
- `locked` — закрыт
- `available` — доступен
- `in_progress` — начат
- `completed` — пройден

**Триггеры:**
- `in_progress` ставится **строго при первом Attempt** внутри юнита.
- `completed` ставится **автоматически** при выполнении условий прохождения (см. ниже).

### 5.3 Условия “юнит пройден”
Юнит считается пройденным, когда:
1) выполнены **все required задачи** (или они “пропущены” после 6 ошибок),
2) достигнут порог `min_counted_tasks` по **counted** задачам.

Unlock следующего юнита:
- логика **AND по всем prereq**,
- prereq считается выполненным по своим условиям (общие для всех исходящих связей),
- `pending_review` фото-задачи не считаются выполненными до принятия.

### 5.4 Override
Учитель может вручную открыть юнит ученику:
- открытие действует **навсегда**,
- не отменяется последующими пересчётами unlock.

---

## 6) Прогресс: две метрики (не путать)
### 6.1 Unit Completion % (counted)
- `completion_percent = counted_tasks / total_tasks * 100%`
- `counted_tasks` растёт, если задача в одном из состояний:
  - `correct`
  - `credited_without_progress`
  - `teacher_credited`

Используется для unlock (через `min_counted_tasks`).

### 6.2 Task Solved % (solved)
- `solved_percent = solved_tasks / total_tasks * 100%`
- `solved_tasks` растёт **только** если:
  - `correct`
  - `accepted` (для фото)
  - `teacher_credited`

“Пропуск” после 6 ошибок **не** увеличивает solved%.

---

## 7) Попытки, блокировки и “пропуск” (3+3)
- Счётчик ошибок ведётся **по задаче и активной ревизии**.
- После **3 неправильных попыток**: блокировка на `X минут` (X — настройка курса).
- После **6 неправильных попыток**:
  - задача становится `credited_without_progress`,
  - показывается правильный ответ и/или решение (если есть),
  - дальнейшие попытки запрещены (кроме действий учителя),
  - если задача required — ставится флаг `required_skipped=true` + уведомление учителю.

### Фото-задачи (manual review)
- `pending_review` → ведущий учитель принимает/отклоняет.
- `rejected` **не увеличивает** счётчик ошибок, пересдачи **безлимитны**.
- `accepted` увеличивает solved% и completion%.

---

## 8) Поиск по понятиям (Concepts)
- Есть справочник **Concept** (`title`, `aliases[]`) и связь `UnitConcept` (m:n).
- Поиск работает по:
  - `Concept.title` и `Concept.aliases`
- Режимы:
  - Student: только опубликованный контент
  - Teacher: поиск **включая draft** (для тестирования/навигации)
- Результат: список юнитов с путём `Course → Section → Unit` и статусом доступности.

---

## 9) Нефункциональные требования (коротко)
- Frontend: Next.js (latest stable), React (latest stable).
- Backend: NestJS, modular monolith.
- Rendering: Tectonic в отдельном worker (queue).
- Storage: S3-compatible (MinIO dev).
- PDF отображение: без браузерного PDF-viewer (встроенный viewer, напр. PDF.js).
- Безопасность:
  - хранить пароли только хэшированно,
  - RBAC на уровне API,
  - signed URLs для файлов только после проверки прав,
  - dependency updates (security-first), избегать уязвимых версий (включая CVE-2025-55182).

---
