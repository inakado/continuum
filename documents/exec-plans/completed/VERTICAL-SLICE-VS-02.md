# VERTICAL-SLICE-VS-02
Статус: `Archived` (migrated execution plan; source of truth — code).

> Этот документ перемещён из `documents/` в `documents/exec-plans/completed/` (plans are first-class artifacts).
Проект: «Континуум»  
Слайс: VS-02 — Dashboards + Graph Editor + Unit Tabs (Theory/Method/Tasks/Video/Attachments)  
Статус: draft (для реализации агентом)

> **Назначение документа:** дать агенту целостную картину VS-02: что делаем, в каком порядке, какие API/таблицы/страницы затрагиваем.  
> **Правило:** перед началом любого шага агент читает `documents/DOCS-INDEX.md`, затем открывает нужные документы (например `ARCHITECTURE.md`, `DESIGN-SYSTEM.md`, `documents/generated/db-schema.md`, `HANDLER-MAP.md`, `DOMAIN-EVENTS.md`).  
> **Важно:** VS-02 не включает прогресс/попытки/unlock — только UX + граф + вкладки юнита.

---

## 0) Цель VS-02 (что получаем в конце)

### Teacher
- После входа учитель попадает в **/teacher** (Dashboard Shell) с левым сайдбаром.
- В режиме **«Создание и редактирование»** учитель:
  - выбирает курс → раздел;
  - видит **ReactFlow-граф** юнитов раздела;
  - может **создавать/удалять/переименовывать** юниты;
  - может **соединять/удалять** рёбра prereq (A → B = A prerequisite для B);
  - может **перетаскивать** узлы и сохранять позиции;
  - **циклы запрещены**, **дубликаты рёбер запрещены**;
  - клик по юниту открывает **Unit Editor** (страница редактирования юнита).

### Student
- После входа ученик попадает в **/student** (Dashboard Shell) с левым сайдбаром.
- В сайдбаре есть **«Курсы»**:
  - в основном окне показываются карточки курсов → выбор курса → доступные разделы → вход в раздел → граф.
- При повторном входе:
  - если ранее ученик посещал раздел, в **/student** сразу отображается **граф последнего посещённого раздела**.
- Граф студента: **тот же UX**, но **read-only** (заморожен), без редактирования.
- Draft контент для ученика **не существует** (не показываем ничего draft; по API это 404/отсутствие в выдаче).

### Unit Page (Student + Teacher view)
- Страница юнита (минимально для просмотра учеником) имеет вкладки:
  - **Теория** (Rich LaTeX → PDF render, как уже принято в проекте)
  - **Методика** (функционально идентична теории: Rich LaTeX → PDF)
  - **Задачи** (пока только список published задач + statement_lite как текст)
  - **Видео** (embed URL → iframe)
  - **Вложения** (список файлов/ссылок на скачивание)
- VS-02 фокусируется на UX и каркасе вкладок, без прогресса/попыток.

---

## 1) Границы VS-02 (что НЕ делаем)

### Вне scope VS-02
- Unlock rules, completion/solved метрики, required-гейты (это будет в следующих слайсах).
- Attempt-логика (3+3, блокировки, credited_without_progress).
- Фото-задачи и очередь проверок.
- Поиск по понятиям, Concepts.
- Аналитика.
- Рендер/компиляция Rich LaTeX воркером (если уже есть, используем; если нет — не делаем полноценный pipeline в VS-02).
- Учительские CRUD-страницы «тестового вида» (они были временными) — интерфейс перерабатывается под dashboard + graph.

---

## 2) Инварианты и правила

### Draft/Published
- Для ученика отображается **только published** контент.
- Если родитель draft → дочернее **не существует** для ученика.
- Если unit draft → узел не показывается студенту в графе.

### Graph rules
- Граф внутри **одного Section** (не пересекает разделы).
- Запрет циклов: нельзя создать ребро, которое делает цикл.
- Запрет дубликатов: нельзя создать 2 ребра с одинаковыми (section_id, from_unit_id, to_unit_id).
- Сохранение positions: перемещение узла сохраняется в БД.

### Student “последний посещённый раздел”
- Это **не прогресс**, не влияет на unlock.
- Просто UX: при входе в /student открываем последний посещённый раздел (если есть).

---

## 3) Порядок разработки (последовательность шагов VS-02)

> Каждый шаг делается «сделали → проверили запуск → только потом следующий».

### STEP 1 — Web: Dashboard Shells + Sidebar + маршрутизация
**Teacher**
- `/teacher` — shell + sidebar (пункты: «Создание и редактирование», «Ученики», «Аналитика» — последние два могут быть ссылками/заглушками)
- В «Создание и редактирование» — входная точка выбора курса/раздела (минимально).

**Student**
- `/student` — shell + sidebar
- «Курсы» — карточки курсов, выбор курса/раздела.

**Проверка:**
- web dev стартует.
- навигация не ломает существующие страницы (VS-01).

---

### STEP 2 — Backend: модель графа + read/write API
#### Данные (DB/Prisma)
Добавить модели:
- `unit_graph_edges`:
  - `id`
  - `section_id`
  - `from_unit_id`
  - `to_unit_id`
  - unique(section_id, from_unit_id, to_unit_id)
- `unit_node_positions` (или `unit_layout`):
  - `unit_id` (PK/FK)
  - `x`, `y`

Добавить модель “student last visited”:
- `student_last_section` (минимально) или поле у StudentProfile:
  - `student_id`
  - `last_section_id`
  - `updated_at`

#### Teacher API
- `GET /teacher/sections/:id/graph`
  - возвращает: units (published/draft — teacher видит всё), positions, edges
- `PUT /teacher/sections/:id/graph`
  - атомарная замена (replace) графа для section:
    - positions (unitId → x,y)
    - edges (from,to)
  - валидации:
    - sectionId един для всех edges
    - нет дубликатов
    - нет циклов → 409

#### Student API
- `GET /student/sections/:id/graph`
  - возвращает только published units + edges между published units + их positions
- `POST /student/sections/:id/visit`
  - фиксирует last_section_id для ученика

**Проверка:**
- миграции применяются
- /health ok
- teacher graph endpoints работают
- student graph скрывает draft узлы

---

### STEP 3 — Teacher UI: Graph Editor (ReactFlow editable)
- В режиме «Создание и редактирование»:
  - выбор курса → раздел → граф
- Возможности:
  - создать юнит (узел)
  - переименовать юнит
  - удалить юнит (с ограничениями, если есть дети/связи — решение фиксируем в реализации)
  - соединить узлы ребром (prereq)
  - удалить ребро
  - drag & drop nodes → сохранение positions
- При клике на узел — переход в Unit Editor (STEP 5)

**Проверка:**
- в UI нельзя создать цикл/дубликат (либо UI блокирует, либо API возвращает 409 с понятным сообщением)
- после refresh граф восстанавливается (edges + positions)

---

### STEP 4 — Student UI: Graph View (ReactFlow frozen) + “последний раздел”
- Student flow:
  - /student → (если есть last_section) сразу граф
  - иначе: «Курсы» → курс → раздел → граф
- Граф read-only:
  - нельзя двигать/редактировать
  - клик по юниту → переход на Unit Page
- При входе в раздел отправлять `POST /student/sections/:id/visit`

**Проверка:**
- последний раздел сохраняется и восстанавливается
- draft не отображается

---

### STEP 5 — Unit Page: вкладки + методика
#### Данные Unit (если ещё нет)
Добавить/подтвердить поля Unit:
- `theory_rich_latex` / `theory_pdf_asset_key` (уже было по требованиям)
- **`method_rich_latex` / `method_pdf_asset_key`** (новое поле VS-02)
- video embeds: список URL (может быть таблица UnitVideo или JSON)
- attachments: список файлов (может быть таблица UnitAttachment или JSON)

#### UI вкладок (Student)
- Теория: рендер PDF как часть страницы (как принято)
- Методика: рендер PDF как теория
- Задачи: список published tasks + statement_lite (просто текст)
- Видео: embed URL → iframe (минимально)
- Вложения: список ссылок/скачиваний

#### UI вкладок (Teacher)
- Просмотр юнита тоже возможен, но редактирование методики/теории может быть упрощено до текстового поля/placeholder (если pipeline Rich LaTeX ещё не готов на этом этапе VS-02).

**Проверка:**
- вкладки переключаются
- методика отображается как отдельная вкладка, не мешая теории

---

## 4) События и аудит (минимально)
VS-02 может писать audit события (если уже есть Events Log из VS-01):
- `SectionGraphUpdated`
- `UnitPositionUpdated` (если пишем отдельно) или только `SectionGraphUpdated`
- `UnitCreatedFromGraph`, `UnitDeletedFromGraph` (если create/delete инициируются из графа)

Это необязательно для функциональности, но желательно для трассировки.

---

## 5) Definition of Done (VS-02 готов)
**Teacher**
- После входа: /teacher с sidebar.
- В режиме «Создание и редактирование»:
  - граф раздела доступен
  - можно создать/удалить/перемещать/соединять юниты
  - циклы и дубликаты рёбер не допускаются (409/ошибка)
  - клик по юниту открывает редактор юнита (страница)

**Student**
- После входа: /student с sidebar.
- Курсы → курс → раздел → граф (read-only).
- Последний посещённый раздел сохраняется, и при повторном входе /student показывает сразу граф.
- Draft контент не виден.

**Unit Page**
- Вкладки: Теория/Методика/Задачи/Видео/Вложения.
- Методика существует как отдельный rich-контент, функционально как теория.

---
