generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  teacher
  student
}

enum ContentStatus {
  draft
  published
}

enum EventCategory {
  admin
  learning
  system
}

enum TaskAnswerType {
  numeric
  single_choice
  multi_choice
  photo
}

enum StudentTaskStatus {
  not_started
  in_progress
  correct
  pending_review
  rejected
  blocked
  credited_without_progress
  teacher_credited
}

enum StudentUnitStatus {
  locked
  available
  in_progress
  completed
}

enum AttemptKind {
  numeric
  single_choice
  multi_choice
  photo
}

enum AttemptResult {
  correct
  incorrect
  pending_review
  accepted
  rejected
}

enum NotificationType {
  photo_reviewed
  unit_override_opened
  required_task_skipped
  task_locked
}

model User {
  id           String   @id @default(uuid()) @db.Uuid
  role         Role
  login        String   @unique
  passwordHash String   @map("password_hash")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  domainEventLogs DomainEventLog[] @relation("DomainEventActor")
  studentProfile StudentProfile?   @relation("StudentProfileUser")
  leadStudents   StudentProfile[]  @relation("StudentProfileLeadTeacher")
  studentUnitStates StudentUnitState[]
  studentTaskStates StudentTaskState[]
  attempts         Attempt[]
  notifications    Notification[]

  @@index([role])
  @@map("users")
}

model StudentProfile {
  userId        String   @id @map("user_id") @db.Uuid
  leadTeacherId String   @map("lead_teacher_id") @db.Uuid
  displayName   String?  @map("display_name")
  firstName     String?  @map("first_name")
  lastName      String?  @map("last_name")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  user        User @relation("StudentProfileUser", fields: [userId], references: [id], onDelete: Cascade)
  leadTeacher User @relation("StudentProfileLeadTeacher", fields: [leadTeacherId], references: [id], onDelete: Restrict)

  @@index([leadTeacherId])
  @@map("student_profile")
}

model Course {
  id          String        @id @default(uuid()) @db.Uuid
  title       String
  description String?
  status      ContentStatus @default(draft)
  lockDurationMinutes Int   @default(30) @map("lock_duration_minutes")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  sections Section[]

  @@index([status])
  @@map("courses")
}

model Section {
  id        String        @id @default(uuid()) @db.Uuid
  courseId  String        @map("course_id") @db.Uuid
  title     String
  status    ContentStatus @default(draft)
  sortOrder Int           @default(0) @map("sort_order")
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")

  course Course @relation(fields: [courseId], references: [id], onDelete: Restrict)
  units  Unit[]

  graphEdges   UnitGraphEdge[]
  graphLayouts UnitGraphLayout[]

  @@index([courseId, status])
  @@index([courseId, sortOrder])
  @@map("sections")
}

model Unit {
  id        String        @id @default(uuid()) @db.Uuid
  sectionId String        @map("section_id") @db.Uuid
  title     String
  description String?     @map("description")
  status    ContentStatus @default(draft)
  sortOrder Int           @default(0) @map("sort_order")
  minOptionalCountedTasksToComplete Int @default(0) @map("min_optional_counted_tasks_to_complete")
  theoryRichLatex    String? @map("theory_rich_latex")
  theoryPdfAssetKey  String? @map("theory_pdf_asset_key")
  methodRichLatex    String? @map("method_rich_latex")
  methodPdfAssetKey  String? @map("method_pdf_asset_key")
  videosJson         Json?   @map("videos_json")
  attachmentsJson    Json?   @map("attachments_json")
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")

  section Section @relation(fields: [sectionId], references: [id], onDelete: Restrict)
  tasks   Task[]
  studentUnitStates StudentUnitState[]

  graphPrereqEdges UnitGraphEdge[]   @relation("GraphPrereqUnit")
  graphNextEdges   UnitGraphEdge[]   @relation("GraphUnit")
  graphLayouts     UnitGraphLayout[] @relation("GraphLayoutUnit")

  @@index([sectionId, status])
  @@index([sectionId, sortOrder])
  @@map("units")
}

model UnitGraphEdge {
  id           String   @id @default(uuid()) @db.Uuid
  sectionId    String   @map("section_id") @db.Uuid
  prereqUnitId String   @map("prereq_unit_id") @db.Uuid
  unitId       String   @map("unit_id") @db.Uuid
  createdAt    DateTime @default(now()) @map("created_at")

  section    Section @relation(fields: [sectionId], references: [id], onDelete: Restrict)
  prereqUnit Unit    @relation("GraphPrereqUnit", fields: [prereqUnitId], references: [id], onDelete: Restrict)
  unit       Unit    @relation("GraphUnit", fields: [unitId], references: [id], onDelete: Restrict)

  @@unique([sectionId, prereqUnitId, unitId])
  @@index([sectionId, unitId])
  @@index([sectionId, prereqUnitId])
  @@map("unit_graph_edges")
}

model UnitGraphLayout {
  id        String   @id @default(uuid()) @db.Uuid
  sectionId String   @map("section_id") @db.Uuid
  unitId    String   @map("unit_id") @db.Uuid
  x         Float
  y         Float
  updatedAt DateTime @updatedAt @map("updated_at")

  section Section @relation(fields: [sectionId], references: [id], onDelete: Restrict)
  unit    Unit    @relation("GraphLayoutUnit", fields: [unitId], references: [id], onDelete: Restrict)

  @@unique([sectionId, unitId])
  @@index([sectionId])
  @@map("unit_graph_layout")
}

model Task {
  id            String        @id @default(uuid()) @db.Uuid
  unitId        String        @map("unit_id") @db.Uuid
  title         String?
  isRequired    Boolean       @default(false) @map("is_required")
  status        ContentStatus @default(draft)
  sortOrder     Int           @default(0) @map("sort_order")
  activeRevisionId String?    @map("active_revision_id") @db.Uuid
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  unit Unit @relation(fields: [unitId], references: [id], onDelete: Restrict)
  activeRevision TaskRevision? @relation("ActiveTaskRevision", fields: [activeRevisionId], references: [id], onDelete: Restrict)
  revisions TaskRevision[] @relation("TaskRevisions")
  studentTaskStates StudentTaskState[]
  attempts Attempt[]

  @@index([unitId, status])
  @@index([unitId, sortOrder])
  @@map("tasks")
}

model TaskRevision {
  id            String        @id @default(uuid()) @db.Uuid
  taskId        String        @map("task_id") @db.Uuid
  revisionNo    Int           @map("revision_no")
  answerType    TaskAnswerType @map("answer_type")
  statementLite String        @map("statement_lite")
  solutionLite  String?       @map("solution_lite")
  createdAt     DateTime      @default(now()) @map("created_at")

  task Task @relation("TaskRevisions", fields: [taskId], references: [id], onDelete: Cascade)
  activeForTasks Task[] @relation("ActiveTaskRevision")
  numericParts TaskRevisionNumericPart[]
  choices TaskRevisionChoice[]
  correctChoices TaskRevisionCorrectChoice[]
  studentTaskStatesActive StudentTaskState[] @relation("StudentTaskStateActiveRevision")
  studentTaskStatesCredited StudentTaskState[] @relation("StudentTaskStateCreditedRevision")
  attempts Attempt[]

  @@unique([taskId, revisionNo])
  @@index([taskId, createdAt])
  @@map("task_revisions")
}

model TaskRevisionNumericPart {
  id             String @id @default(uuid()) @db.Uuid
  taskRevisionId String @map("task_revision_id") @db.Uuid
  partKey        String @map("part_key")
  labelLite      String? @map("label_lite")
  correctValue   String @map("correct_value")

  taskRevision TaskRevision @relation(fields: [taskRevisionId], references: [id], onDelete: Cascade)

  @@unique([taskRevisionId, partKey])
  @@index([taskRevisionId])
  @@map("task_revision_numeric_parts")
}

model TaskRevisionChoice {
  id             String @id @default(uuid()) @db.Uuid
  taskRevisionId String @map("task_revision_id") @db.Uuid
  choiceKey      String @map("choice_key")
  contentLite    String @map("content_lite")

  taskRevision TaskRevision @relation(fields: [taskRevisionId], references: [id], onDelete: Cascade)

  @@unique([taskRevisionId, choiceKey])
  @@index([taskRevisionId])
  @@map("task_revision_choices")
}

model TaskRevisionCorrectChoice {
  id             String @id @default(uuid()) @db.Uuid
  taskRevisionId String @map("task_revision_id") @db.Uuid
  choiceKey      String @map("choice_key")

  taskRevision TaskRevision @relation(fields: [taskRevisionId], references: [id], onDelete: Cascade)

  @@unique([taskRevisionId, choiceKey])
  @@index([taskRevisionId])
  @@map("task_revision_correct_choices")
}

model StudentUnitState {
  studentId         String            @map("student_id") @db.Uuid
  unitId            String            @map("unit_id") @db.Uuid
  status            StudentUnitStatus
  overrideOpened    Boolean           @default(false) @map("override_opened")
  countedTasks      Int               @default(0) @map("counted_tasks")
  solvedTasks       Int               @default(0) @map("solved_tasks")
  totalTasks        Int               @default(0) @map("total_tasks")
  completionPercent Int               @default(0) @map("completion_percent")
  solvedPercent     Int               @default(0) @map("solved_percent")
  becameAvailableAt DateTime?         @map("became_available_at")
  startedAt         DateTime?         @map("started_at")
  completedAt       DateTime?         @map("completed_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")

  student User @relation(fields: [studentId], references: [id], onDelete: Cascade)
  unit    Unit @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@id([studentId, unitId])
  @@index([unitId, status])
  @@index([studentId, status])
  @@map("student_unit_state")
}

model StudentTaskState {
  studentId         String           @map("student_id") @db.Uuid
  taskId            String           @map("task_id") @db.Uuid
  status            StudentTaskStatus
  activeRevisionId  String           @map("active_revision_id") @db.Uuid
  wrongAttempts     Int              @default(0) @map("wrong_attempts")
  lockedUntil       DateTime?        @map("locked_until")
  requiredSkipped   Boolean          @default(false) @map("required_skipped")
  creditedRevisionId String?         @map("credited_revision_id") @db.Uuid
  creditedAt        DateTime?        @map("credited_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")

  student User @relation(fields: [studentId], references: [id], onDelete: Cascade)
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  activeRevision TaskRevision @relation("StudentTaskStateActiveRevision", fields: [activeRevisionId], references: [id], onDelete: Restrict)
  creditedRevision TaskRevision? @relation("StudentTaskStateCreditedRevision", fields: [creditedRevisionId], references: [id], onDelete: SetNull)

  @@id([studentId, taskId])
  @@index([studentId, status])
  @@index([taskId, status])
  @@index([lockedUntil])
  @@map("student_task_state")
}

model Attempt {
  id               String        @id @default(uuid()) @db.Uuid
  studentId        String        @map("student_id") @db.Uuid
  taskId           String        @map("task_id") @db.Uuid
  taskRevisionId   String        @map("task_revision_id") @db.Uuid
  attemptNo        Int           @map("attempt_no")
  createdAt        DateTime      @default(now()) @map("created_at")
  kind             AttemptKind
  numericAnswers   Json?         @map("numeric_answers")
  selectedChoiceKey String?      @map("selected_choice_key")
  selectedChoiceKeys Json?       @map("selected_choice_keys")
  result           AttemptResult

  student User @relation(fields: [studentId], references: [id], onDelete: Cascade)
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskRevision TaskRevision @relation(fields: [taskRevisionId], references: [id], onDelete: Cascade)

  @@unique([studentId, taskRevisionId, attemptNo])
  @@index([studentId, createdAt])
  @@index([taskId, createdAt])
  @@index([taskRevisionId, createdAt])
  @@map("attempts")
}

model Notification {
  id              String           @id @default(uuid()) @db.Uuid
  recipientUserId String           @map("recipient_user_id") @db.Uuid
  type            NotificationType
  payload         Json
  createdAt       DateTime         @default(now()) @map("created_at")
  readAt          DateTime?        @map("read_at")

  recipientUser User @relation(fields: [recipientUserId], references: [id], onDelete: Cascade)

  @@index([recipientUserId, readAt, createdAt])
  @@map("notifications")
}

model DomainEventLog {
  id          String        @id @default(uuid()) @db.Uuid
  category    EventCategory
  eventType   String        @map("event_type")
  actorUserId String?       @map("actor_user_id") @db.Uuid
  entityType  String        @map("entity_type")
  entityId    String        @map("entity_id") @db.Uuid
  payload     Json
  occurredAt  DateTime      @default(now()) @map("occurred_at")

  actorUser User? @relation("DomainEventActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([occurredAt])
  @@index([category, occurredAt])
  @@index([eventType, occurredAt])
  @@index([actorUserId, occurredAt])
  @@index([entityType, entityId])
  @@map("domain_event_log")
}
